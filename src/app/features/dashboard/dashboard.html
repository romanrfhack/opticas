<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-title">
      <h1>Dashboard</h1>
      <p>Resumen general de actividades y métricas</p>
    </div>
    <!-- <div class="header-actions">
      <button class="btn-export" (click)="exportReport()">
        <span class="material-icons">download</span>
        Exportar Reporte
      </button>
    </div> -->
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <form [formGroup]="filterForm" class="filters-form">
      <div class="filter-group">
        <label>Período:</label>
        <select formControlName="period">
          <option *ngFor="let period of periods" [value]="period.value">
            {{ period.label }}
          </option>
        </select>
      </div>

      <div class="filter-group" *ngIf="filterForm.get('period')?.value === 'custom'">
        <label>Desde:</label>
        <input type="date" formControlName="startDate" />
        <label>Hasta:</label>
        <input type="date" formControlName="endDate" />
      </div>

      <div class="filter-group">
        <label>Sucursal:</label>
        <select formControlName="branchId" [disabled]="loadingBranches()">
          <option
            *ngFor="let branch of branches()"
            [value]="branch.id"
            [disabled]="branch.id !== 'all' && !branch.activa"
          >
            {{ branch.nombre }}
            {{ branch.id !== 'all' && !branch.activa ? '(Inactiva)' : '' }}
          </option>
        </select>
        <div *ngIf="loadingBranches()" class="loading-small">
          Cargando sucursales...
        </div>
      </div>

      <!-- <button
        type="button"
        class="btn-apply"
        (click)="loadDashboardData()"
        [disabled]="loading()"
      >
        <span class="material-icons">refresh</span>
        {{ loading() ? 'Cargando...' : 'Actualizar' }}
      </button> -->
    </form>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading-section">
    <div class="loading-spinner">
      <span class="material-icons">refresh</span>
      Cargando datos del dashboard...
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-section" *ngIf="!loading()">
    <div class="kpi-grid">
      <div
        *ngFor="let kpi of kpis()"
        class="kpi-card"
        [class]="'trend-' + kpi.trend"
      >
        <div class="kpi-icon">
          <span class="material-icons">{{ kpi.icon }}</span>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">
            {{
              kpi.title.includes('Ingresos')
                ? ('$' + (kpi.value | number : '1.0-0'))
                : (kpi.value | number)
            }}
          </div>
          <div class="kpi-title">{{ kpi.title }}</div>
          <div class="kpi-change">
            <span class="change-indicator" [class]="kpi.trend">
              <span class="material-icons">
                {{
                  kpi.trend === 'up'
                    ? 'arrow_upward'
                    : kpi.trend === 'down'
                    ? 'arrow_downward'
                    : 'remove'
                }}
              </span>
              {{ kpi.change | number : '1.1-1' }}%
            </span>
            vs período anterior
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficas -->
  <div class="charts-section" *ngIf="!loading()">
    <div class="charts-grid">

      <!-- Pacientes Atendidos -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Pacientes Atendidos</h3>
          <span class="chart-subtitle">Total vs Nuevos pacientes</span>
        </div>
        <div class="chart-container">
          <div class="chart-simulation">
            <div class="bar-chart-sim">
              <div
                *ngFor="let day of patientAttendanceData().labels; let i = index"
                class="bar-group"
              >
                <div
                  class="bar total"
                  [style.height]="(patientAttendanceData().datasets[0].data[i] || 0) * 2 + 'px'"
                ></div>
                <div
                  class="bar new"
                  [style.height]="(patientAttendanceData().datasets[1].data[i] || 0) * 2 + 'px'"
                ></div>
                <span class="bar-label">{{ day }}</span>
              </div>
            </div>
            <div class="chart-legend">
              <span class="legend-item"
                ><div class="color total"></div> Total</span
              >
              <span class="legend-item"
                ><div class="color new"></div> Nuevos</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Métodos de pago -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Métodos de Pago</h3>
          <span class="chart-subtitle">Distribución por tipo</span>
        </div>
        <div class="chart-container">
          <div
            class="pie-chart-sim"
            *ngIf="paymentMethodsData().labels.length > 0"
          >
            <div
              class="pie"
              [style.background]="getPaymentMethodsGradient()"
            ></div>
            <div class="pie-legend">
              <div
                *ngFor="
                  let method of paymentMethodsData().labels;
                  let i = index
                "
                class="legend-item"
              >
                <div
                  class="color"
                  [style.background]="
                    paymentMethodsData().datasets[0].backgroundColor[i]
                  "
                ></div>
                {{ method }}:
                {{ paymentMethodsData().datasets[0].data[i] }}%
              </div>
            </div>
          </div>
          <div *ngIf="paymentMethodsData().labels.length === 0" class="no-data">
            No hay datos de pagos
          </div>
        </div>
      </div>

      <!-- Estados de órdenes -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Estados de Órdenes</h3>
          <span class="chart-subtitle">Distribución actual</span>
        </div>
        <div class="chart-container">
          <div
            class="doughnut-chart-sim"
            *ngIf="orderStatusData().labels.length > 0"
          >
            <div
              class="doughnut"
              [style.background]="getOrderStatusGradient()"
            ></div>
            <div class="chart-legend">
              <div
                *ngFor="let status of orderStatusData().labels; let i = index"
                class="legend-item"
              >
                <div
                  class="color"
                  [style.background]="
                    orderStatusData().datasets[0].backgroundColor[i]
                  "
                ></div>
                {{ status }}:
                {{ orderStatusData().datasets[0].data[i] }}
              </div>
            </div>
          </div>
          <div *ngIf="orderStatusData().labels.length === 0" class="no-data">
            No hay datos de órdenes
          </div>
        </div>
      </div>

      <!-- Ventas por categoría -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Ventas por Categoría</h3>
          <span class="chart-subtitle">Este mes</span>
        </div>
        <div class="chart-container">
          <div
            class="horizontal-bar-sim"
            *ngIf="salesByCategoryData().labels.length > 0"
          >
            <div
              *ngFor="
                let category of salesByCategoryData().labels;
                let i = index
              "
              class="bar-item"
            >
              <span class="category-label">{{ category }}</span>
              <div class="bar-track">
                <div
                  class="bar-fill"
                  [style.background]="
                    salesByCategoryData().datasets[0].backgroundColor[i]
                  "
                  [style.width]="
                    (salesByCategoryData().datasets[0].data[i] || 0) + '%'
                  "
                >
                  <span class="bar-value">
                    {{ salesByCategoryData().datasets[0].data[i] }}%
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="salesByCategoryData().labels.length === 0" class="no-data">
            No hay datos de ventas
          </div>
        </div>
      </div>

      <!-- Ingresos mensuales -->
      <div class="chart-card wide">
        <div class="chart-header">
          <h3>Ingresos Mensuales</h3>
          <span class="chart-subtitle">Comparativo anual</span>
        </div>
        <div class="chart-container">
          <div
            class="line-chart-sim"
            *ngIf="monthlyRevenueData().labels.length > 0"
          >
            <div class="line-group">
              <div class="line current-year">
                <div
                  class="line-point"
                  *ngFor="
                    let point of monthlyRevenueData().datasets[0].data;
                    let i = index
                  "
                  [style.left]="
                    i * (100 / (monthlyRevenueData().labels.length - 1)) + '%'
                  "
                  [style.bottom]="(point / 2000) + 'px'"
                >
                  <span class="point-value"
                    >${{ point / 1000 | number : '1.0-0' }}K</span
                  >
                </div>
              </div>
              <div class="line previous-year">
                <div
                  class="line-point"
                  *ngFor="
                    let point of monthlyRevenueData().datasets[1].data;
                    let i = index
                  "
                  [style.left]="
                    i * (100 / (monthlyRevenueData().labels.length - 1)) + '%'
                  "
                  [style.bottom]="(point / 2000) + 'px'"
                >
                  <span class="point-value"
                    >${{ point / 1000 | number : '1.0-0' }}K</span
                  >
                </div>
              </div>
            </div>
            <div class="x-axis">
              <span
                *ngFor="let label of monthlyRevenueData().labels"
                class="axis-label"
                >{{ label }}</span
              >
            </div>
            <div class="chart-legend">
              <span class="legend-item"
                ><div class="color primary"></div>
                {{ monthlyRevenueData().datasets[0].label }}</span
              >
              <span class="legend-item"
                ><div class="color secondary"></div>
                {{ monthlyRevenueData().datasets[1].label }}</span
              >
            </div>
          </div>
          <div *ngIf="monthlyRevenueData().labels.length === 0" class="no-data">
            No hay datos de ingresos
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
