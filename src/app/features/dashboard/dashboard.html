<div class="p-6 space-y-6 bg-gradient-to-b from-blue-50 to-white min-h-screen">
  <!-- Header -->
  <div
    class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-2xl p-6 shadow-md flex flex-col md:flex-row justify-between items-center"
  >
    <div>
      <h1 class="text-3xl font-extrabold">Dashboard</h1>
      <p class="text-blue-100 mt-1 text-sm">Resumen general de métricas</p>
    </div>
    <div class="flex items-center gap-4 mt-4 md:mt-0">
      <div class="text-right">
        <p class="font-semibold">
          Bienvenido, <span class="text-white/90">Administrador</span>
        </p>
        <p class="text-blue-100 text-sm">Sucursal: Todas</p>
      </div>
      <img
        src="https://cdn-icons-png.flaticon.com/512/3177/3177440.png"
        alt="Usuario"
        class="w-14 h-14 rounded-full border-2 border-white shadow-lg"
      />
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white rounded-2xl shadow p-5">
    <form [formGroup]="filterForm" class="flex flex-wrap items-end gap-4">
      <div class="flex flex-col">
        <label class="text-sm font-semibold text-gray-700">Período:</label>
        <select
          formControlName="period"
          class="border border-gray-300 rounded-md px-3 py-2 focus:border-blue-400 focus:ring-1 focus:ring-blue-200"
        >
          <option *ngFor="let p of periods" [value]="p.value">{{ p.label }}</option>
        </select>
      </div>

      <div
        *ngIf="filterForm.get('period')?.value === 'custom'"
        class="flex items-end gap-2"
      >
        <div class="flex flex-col">
          <label class="text-sm font-semibold text-gray-700">Desde:</label>
          <input
            type="date"
            formControlName="startDate"
            class="border border-gray-300 rounded-md px-3 py-2 focus:border-blue-400 focus:ring-1 focus:ring-blue-200"
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-semibold text-gray-700">Hasta:</label>
          <input
            type="date"
            formControlName="endDate"
            class="border border-gray-300 rounded-md px-3 py-2 focus:border-blue-400 focus:ring-1 focus:ring-blue-200"
          />
        </div>
      </div>

      <div class="flex flex-col">
        <label class="text-sm font-semibold text-gray-700">Sucursal:</label>
        <select
          formControlName="branchId"
          class="border border-gray-300 rounded-md px-3 py-2 focus:border-blue-400 focus:ring-1 focus:ring-blue-200"
        >
          <option
            *ngFor="let branch of branches()"
            [value]="branch.id"
            [disabled]="branch.id !== 'all' && !branch.activa"
          >
            {{ branch.nombre }}
            {{ branch.id !== 'all' && !branch.activa ? '(Inactiva)' : '' }}
          </option>
        </select>
      </div>

      <button
        type="button"
        class="bg-blue-500 text-white px-5 py-2 rounded-md font-semibold hover:bg-blue-600 transition-all"
        (click)="loadDashboardData()"
      >
        <span class="material-icons align-middle mr-1 text-sm">refresh</span>
        Actualizar
      </button>
    </form>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="flex justify-center items-center py-10 text-gray-500">
    <span class="material-icons animate-spin mr-2">refresh</span>
    Cargando datos del dashboard...
  </div>

  <!-- KPI -->
  <div *ngIf="!loading()" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6">
    <div
      *ngFor="let kpi of kpis"
      class="flex items-center gap-4 bg-white p-5 rounded-2xl shadow-md hover:-translate-y-1 hover:shadow-lg transition"
    >
      <div
        class="p-4 rounded-full text-white shadow-md"
        [ngClass]="{
          'bg-blue-500': kpi.iconColor === 'blue',
          'bg-green-500': kpi.iconColor === 'green',
          'bg-cyan-500': kpi.iconColor === 'cyan',
          'bg-yellow-500': kpi.iconColor === 'yellow',
          'bg-red-500': kpi.iconColor === 'red'
        }"
      >
        <span class="material-icons text-3xl">{{ kpi.icon }}</span>
      </div>
      <div>
        <div class="text-2xl font-bold text-gray-800">
          {{ kpi.isMoney ? ('$' + (kpi.value | number:'1.0-2')) : (kpi.value | number) }}
        </div>
        <div class="text-sm text-gray-500">{{ kpi.title }}</div>
        <div class="text-xs mt-1">
          <span
            [ngClass]="{
              'text-green-500': kpi.change > 0,
              'text-red-500': kpi.change < 0,
              'text-yellow-500': kpi.change === 0
            }"
          >
            {{ kpi.change | number : '1.1-1' }}%
          </span>
          <span class="text-gray-400 ml-1">vs período anterior</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div *ngIf="!loading()" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
    <!-- Pacientes -->
    <div class="bg-white rounded-2xl shadow p-5 hover:shadow-lg transition">
      <h3 class="text-lg font-bold text-blue-600">Pacientes Atendidos</h3>
      <p class="text-sm text-gray-500 mb-3">Total vs Nuevos</p>
      <apx-chart
        [series]="patientsChart.series || []"
        [chart]="patientsChart.chart ?? { type: 'bar' }"
        [xaxis]="patientsChart.xaxis ?? {}"
        [dataLabels]="patientsChart.dataLabels ?? {}"
        [plotOptions]="patientsChart.plotOptions ?? {}"
        [colors]="patientsChart.colors ?? []"
        [grid]="patientsChart.grid ?? {}"
      ></apx-chart>
    </div>

    <!-- Métodos de Pago -->
    <div class="bg-white rounded-2xl shadow p-5 hover:shadow-lg transition">
      <h3 class="text-lg font-bold text-blue-600">Métodos de Pago</h3>
      <p class="text-sm text-gray-500 mb-3">Distribución por tipo</p>
      <apx-chart
        [series]="paymentsChart.series || []"
        [chart]="paymentsChart.chart ?? { type: 'pie' }"
        [labels]="paymentsChart.labels || []"
        [colors]="paymentsChart.colors || []"
        [legend]="paymentsChart.legend || {}"
      ></apx-chart>
    </div>

    <!-- Estados de Órdenes -->
    <div class="bg-white rounded-2xl shadow p-5 hover:shadow-lg transition">
      <h3 class="text-lg font-bold text-blue-600">Estados de Órdenes</h3>
      <p class="text-sm text-gray-500 mb-3">Distribución actual</p>
      <apx-chart
        [series]="ordersChart.series || []"
        [chart]="ordersChart.chart ?? { type: 'pie' }"
        [labels]="ordersChart.labels || []"
        [colors]="ordersChart.colors || []"
        [legend]="ordersChart.legend || {}"
      ></apx-chart>
    </div>

    <!-- Ventas por Categoría -->
    <div class="bg-white rounded-2xl shadow p-5 hover:shadow-lg transition">
      <h3 class="text-lg font-bold text-blue-600">Ventas por Categoría</h3>
      <p class="text-sm text-gray-500 mb-3">Este periodo</p>
      <apx-chart
        [series]="salesChart.series || []"
        [chart]="salesChart.chart ?? { type: 'bar' }"
        [xaxis]="salesChart.xaxis || {}"
        [plotOptions]="salesChart.plotOptions || {}"
        [colors]="salesChart.colors || []"
        [dataLabels]="salesChart.dataLabels || {}"
      ></apx-chart>
    </div>
  </div>
</div>
