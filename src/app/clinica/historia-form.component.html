<div class="max-w-7xl mx-auto space-y-8 p-4 dashboard-container">
  <!-- Progress Bar -->
  <mat-progress-bar mode="indeterminate" *ngIf="loading()" class="rounded-full"></mat-progress-bar>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Col 1-2: Formulario principal -->
    <div class="lg:col-span-2 space-y-8">
      
      <!-- Paciente Section -->
      <app-paciente-form
        *ngIf="!pacienteId()"
        [pacForm]="pacForm"
        [sugeridos]="sugeridos()"
        (selectPaciente)="selectPaciente($event)"
        (crearPaciente)="crearPaciente()">
      </app-paciente-form>

      <!-- Tarjeta compacta del paciente -->
      <app-paciente-card
        *ngIf="pacienteId()"
        [pacForm]="pacForm"
        (editarPaciente)="editarPaciente()">
      </app-paciente-card>

      <!-- Resto del formulario -->
      <div *ngIf="pacienteId()" class="space-y-8">
        <!-- Agudeza Visual -->
        <app-agudeza-visual
          [(avSinOD)]="avSinOD"
          [(avSinOI)]="avSinOI"
          [(avConOD)]="avConOD"
          [(avConOI)]="avConOI">
        </app-agudeza-visual>

        <!-- RX Section -->
        <app-rx-form [filasRx]="filasRx"></app-rx-form>

        <!-- Materiales Section -->        
        <app-materiales-form
          [materiales]="materiales()"
          [materialesSel]="materialesSel()"
          (agregarMaterial)="agregarMaterial($event)"
          (quitarMaterial)="quitarMaterial($event)"
          [(materialSelId)]="materialSelId"
          [(materialObs)]="materialObs"
          (armazonesChange)="onArmazonesChange($event)"
          (lentesContactoChange)="onLentesContactoChange($event)"> <!-- NUEVO OUTPUT -->
        </app-materiales-form>

        <!-- Lente de Contacto Section -->
        <!-- <app-lentes-contacto
          [lcSel]="lcSel()"
          (agregarLC)="agregarLC()"
          (quitarLC)="quitarLC($event)"
          [(lcTipo)]="lcTipo"
          [(lcMarca)]="lcMarca"
          [(lcModelo)]="lcModelo"
          [(lcObs)]="lcObs">
        </app-lentes-contacto> -->

        <!-- Observaciones -->                
        <mat-card class="form-card">
          <mat-card-header class="border-b border-gray-100 pb-4 mb-4">
            <mat-card-title class="flex items-center gap-2 text-lg font-semibold">
              <mat-icon [style.color]="'#06b6d4'" class="text-primary">notes</mat-icon>
              Observaciones Finales
            </mat-card-title>
            <mat-card-subtitle class="text-gray-600">Notas adicionales del examen</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <mat-form-field appearance="fill" class="w-full custom-form-field">
              <mat-label>Observaciones y notas del examen</mat-label>
              <textarea rows="4" matInput [(ngModel)]="observaciones" 
                        placeholder="Escribe aquí cualquier observación importante..."></textarea>
              <mat-icon matPrefix class="prefix-icon">notes</mat-icon>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Botones de Acción -->
        <mat-card class="form-card">
          <mat-card-content>
            <div class="flex gap-4">
              <button mat-flat-button 
                      color="primary" 
                      (click)="guardarBorrador()" 
                      [disabled]="!pacienteId()"
                      class="save-button flex-1 py-3">
                <mat-icon>save</mat-icon>
                Guardar Borrador
              </button>
              <button mat-flat-button 
                      color="accent" 
                      (click)="registrarPagoAdelanto()" 
                      [disabled]="!historiaId()"
                      class="payment-button flex-1 py-3">
                <mat-icon>payments</mat-icon>
                Registrar pago / adelanto
              </button>
            </div>
            
            <!-- Estado del formulario (opcional, para debug) -->
            <div class="mt-4 p-3 bg-gray-50 rounded-lg" *ngIf="false"> <!-- Cambia a *ngIf="true" para ver el estado -->
              <h4 class="font-medium text-sm text-gray-700 mb-2">Estado del formulario:</h4>
              <div class="text-xs text-gray-600 space-y-1">
                <div>Paciente: {{ pacienteId() ? 'Seleccionado' : 'No seleccionado' }}</div>
                <div>Agudeza Visual: {{ (avSinOD || avSinOI || avConOD || avConOI) ? 'Capturada' : 'No capturada' }}</div>
                <div>RX: {{ filasRx.length > 0 ? 'Configurada' : 'No configurada' }}</div>
                <div>Materiales: {{ materialesSel().length }} seleccionados</div>
                <div>Armazones: {{ armazonesSel.length }} seleccionados</div>
                <div>Lentes Contacto: {{ lentesContactoSel.length }} seleccionados</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Col 3: Últimas visitas -->
    <div class="space-y-8" *ngIf="pacienteId()">
      <mat-card class="form-card">
        <mat-card-header class="border-b border-gray-100 pb-4">
          <mat-card-title class="flex items-center gap-2 text-lg font-semibold">
            <mat-icon class="text-primary">history</mat-icon>
            Historial del Paciente
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <app-ultimas-visitas [pacienteId]="pacienteId()"></app-ultimas-visitas>            
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>