<div class="max-w-7xl mx-auto space-y-8 p-4 dashboard-container">
  
  <mat-progress-bar mode="indeterminate" *ngIf="loading()" class="rounded-full"></mat-progress-bar>
  <mat-progress-bar mode="indeterminate" *ngIf="cargandoPacienteDesdeUrl()" class="rounded-full bg-blue-500"></mat-progress-bar>
  <div *ngIf="cargandoPacienteDesdeUrl()" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
  <div class="flex items-center gap-3">  <mat-spinner diameter="24"></mat-spinner> <span class="text-blue-700 font-medium">Cargando paciente...</span> </div>
</div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Col 1-2: Formulario principal -->
    <div class="lg:col-span-2 space-y-8">
      
      <!-- Paciente Section -->
      <app-paciente-form
        *ngIf="!pacienteId()"
        [pacForm]="pacForm"
        [sugeridos]="sugeridos()"
        (selectPaciente)="selectPaciente($event)"
        (crearPaciente)="crearPaciente()">
      </app-paciente-form>

      <!-- Tarjeta compacta del paciente -->
      <app-paciente-card
        *ngIf="pacienteId()"
        [pacForm]="pacForm"
        (editarPaciente)="editarPaciente()">
      </app-paciente-card>

      <!-- Resto del formulario -->
      <div *ngIf="pacienteId()" class="space-y-8">
        <!-- Agudeza Visual -->
        <app-agudeza-visual
          [(avSinOD)]="avSinOD"
          [(avSinOI)]="avSinOI"
          [(avConOD)]="avConOD"
          [(avConOI)]="avConOI">
        </app-agudeza-visual>

        <!-- RX Section -->
        <app-rx-form [filasRx]="filasRx"></app-rx-form>

        <!-- Materiales Section -->        
        <app-materiales-form
          [materiales]="materiales()"
          [materialesSel]="materialesSel()"
          (agregarMaterial)="agregarMaterial($event)"
          (quitarMaterial)="quitarMaterial($event)"
          [(materialSelId)]="materialSelId"
          [(materialObs)]="materialObs"
          (armazonesChange)="onArmazonesChange($event)"
          (lentesContactoChange)="onLentesContactoChange($event)"> <!-- NUEVO OUTPUT -->
        </app-materiales-form>        

                
        <!-- Observaciones y Total a Cobrar -->
        <mat-card class="form-card">
          <mat-card-header class="border-b border-gray-100 pb-4 mb-4">
            <mat-card-title class="flex items-center gap-2 text-lg font-semibold">
              <mat-icon [style.color]="'#06b6d4'" class="text-primary">notes</mat-icon>
              Observaciones Finales y Total a Cobrar
            </mat-card-title>
            <mat-card-subtitle class="text-gray-600">Notas adicionales del examen y desglose de costos</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content class="space-y-6">            
            <!-- Sección de Total a Cobrar -->
            <div class="border-t border-gray-200 pt-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <mat-icon class="text-green-600">attach_money</mat-icon>
                Total a Cobrar
              </h3>
              
              <!-- Desglose de costos -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Columna 1 -->
                <div class="space-y-3">
                  <!-- Consulta -->
                  <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">Consulta:</label>
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-500">$</span>
                      <input type="number" 
                            [(ngModel)]="precioConsulta"
                            min="0"
                            step="0.01"
                            class="w-24 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                            placeholder="0.00">
                    </div>
                  </div>

                  <!-- Servicios -->
                  <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">Servicios:</label>
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-500">$</span>
                      <input type="number" 
                            [(ngModel)]="precioServicios"
                            min="0"
                            step="0.01"
                            class="w-24 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                            placeholder="0.00">
                    </div>
                  </div>

                  <!-- Materiales -->
                  <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">Materiales ({{ materialesSel().length }}):</label>
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-500">$</span>
                      <input type="number" 
                            [(ngModel)]="precioMateriales"
                            min="0"
                            step="0.01"
                            class="w-24 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                            placeholder="0.00">
                    </div>
                  </div>
                </div>

                <!-- Columna 2 -->
                <div class="space-y-3">
                  <!-- Armazones -->
                  <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">Armazones ({{ armazonesSel.length }}):</label>
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-500">$</span>
                      <input type="number" 
                            [(ngModel)]="precioArmazones"
                            min="0"
                            step="0.01"
                            class="w-24 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                            placeholder="0.00">
                    </div>
                  </div>

                  <!-- Lentes de Contacto -->
                  <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">Lentes Contacto ({{ lentesContactoSel.length }}):</label>
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-500">$</span>
                      <input type="number" 
                            [(ngModel)]="precioLentesContacto"
                            min="0"
                            step="0.01"
                            class="w-24 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                            placeholder="0.00">
                    </div>
                  </div>

                  <!-- Espacio para futuros conceptos -->
                  <div class="h-8"></div> <!-- Espaciador -->
                </div>
              </div>

              <!-- Total General -->
              <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 border border-green-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-green-600">summarize</mat-icon>
                    <span class="font-medium text-green-800">TOTAL GENERAL:</span>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold text-green-900">{{ formatearMoneda(totalACobrar) }}</div>
                    <div class="text-sm text-green-700">IVA incluido</div>
                  </div>
                </div>
                
                <!-- Desglose automático del total -->
                <div class="mt-3 grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                  <div *ngIf="precioConsulta > 0" class="text-center bg-white rounded p-1">
                    <div class="font-medium">Consulta</div>
                    <div class="text-green-600">{{ formatearMoneda(precioConsulta) }}</div>
                  </div>
                  <div *ngIf="precioServicios > 0" class="text-center bg-white rounded p-1">
                    <div class="font-medium">Servicios</div>
                    <div class="text-green-600">{{ formatearMoneda(precioServicios) }}</div>
                  </div>
                  <div *ngIf="precioMateriales > 0" class="text-center bg-white rounded p-1">
                    <div class="font-medium">Materiales</div>
                    <div class="text-green-600">{{ formatearMoneda(precioMateriales) }}</div>
                  </div>
                  <div *ngIf="precioArmazones > 0" class="text-center bg-white rounded p-1">
                    <div class="font-medium">Armazones</div>
                    <div class="text-green-600">{{ formatearMoneda(precioArmazones) }}</div>
                  </div>
                  <div *ngIf="precioLentesContacto > 0" class="text-center bg-white rounded p-1">
                    <div class="font-medium">Lentes Contacto</div>
                    <div class="text-green-600">{{ formatearMoneda(precioLentesContacto) }}</div>
                  </div>
                </div>
              </div>

              <!-- Nota sobre el total -->
              <div class="mt-3 text-xs text-gray-500 text-center">
                Este total se enviará al módulo de pagos cuando registres un pago/adelanto
              </div>
            </div>
            <!-- Campo de observaciones existente -->
            <mat-form-field appearance="fill" class="w-full custom-form-field">
              <mat-label>Observaciones y notas del examen</mat-label>
              <textarea rows="4" matInput [(ngModel)]="observaciones" 
                        placeholder="Escribe aquí cualquier observación importante..."></textarea>
              <mat-icon matPrefix class="prefix-icon">notes</mat-icon>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

         <!-- Historial del Paciente (existente) -->
  <!-- <mat-card class="form-card">
    <mat-card-header class="border-b border-gray-100 pb-4">
      <mat-card-title class="flex items-center gap-2 text-lg font-semibold">
        <mat-icon class="text-primary">history</mat-icon>
        Historial del Paciente
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <app-ultimas-visitas [pacienteId]="pacienteId()"></app-ultimas-visitas>            
    </mat-card-content>
  </mat-card> -->

  <!-- NUEVA SECCIÓN: Pagos Registrados -->
  <mat-card class="form-card">
    <mat-card-header class="border-b border-gray-100 pb-4">
      <div class="flex items-center justify-between w-full">
        <mat-card-title class="flex items-center gap-2 text-lg font-semibold">
          <mat-icon class="text-primary">payments</mat-icon>
          Pagos Registrados
          <span class="text-sm font-normal text-gray-500 ml-2">
            ({{ pagosRegistrados().length }})
          </span>
        </mat-card-title>
        <button mat-stroked-button 
                (click)="togglePagos()"
                [disabled]="!historiaId()"
                class="action-button">
          <mat-icon>{{ mostrandoPagos() ? 'visibility_off' : 'visibility' }}</mat-icon>
          {{ mostrandoPagos() ? 'Ocultar' : 'Ver' }} Pagos
        </button>
      </div>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Estado cuando no hay historia -->
      <div *ngIf="!historiaId()" class="text-center py-8 text-gray-500">
        <mat-icon class="text-4xl mb-2 opacity-50">receipt_long</mat-icon>
        <p>Guarda la visita primero para registrar pagos</p>
      </div>

      <!-- Estado cuando hay historia pero no se muestran pagos -->
      <div *ngIf="historiaId() && !mostrandoPagos()" class="text-center py-8 text-gray-500">
        <mat-icon class="text-4xl mb-2 opacity-50">payments</mat-icon>
        <p>Haz clic en "Ver Pagos" para mostrar los pagos registrados</p>
      </div>

      <!-- Loading state -->
      <div *ngIf="mostrandoPagos() && cargandoPagos()" class="text-center py-8">
        <mat-progress-bar mode="indeterminate" class="mb-4"></mat-progress-bar>
        <p class="text-gray-600">Cargando pagos...</p>
      </div>

      <!-- Lista de pagos -->
      <div *ngIf="mostrandoPagos() && !cargandoPagos()">
        <!-- Resumen -->
        <div *ngIf="pagosRegistrados().length > 0" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <mat-icon class="text-blue-600">summarize</mat-icon>
              <span class="font-medium text-blue-800">Resumen de Pagos</span>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-blue-900">{{ totalPagado | number:'1.2-2' }}</div>
              <div class="text-sm text-blue-700">Total pagado</div>
            </div>
          </div>
        </div>

        <!-- Lista vacía -->
        <div *ngIf="pagosRegistrados().length === 0" class="text-center py-8 text-gray-500">
          <mat-icon class="text-4xl mb-2 opacity-50">payments_off</mat-icon>
          <p class="mb-4">No hay pagos registrados para esta visita</p>
          <button mat-stroked-button 
                  (click)="registrarPagoAdelanto()"
                  class="action-button">
            <mat-icon>add</mat-icon>
            Registrar Primer Pago
          </button>
        </div>

        <!-- Lista de pagos -->
        <div *ngIf="pagosRegistrados().length > 0" class="space-y-3">
          <div *ngFor="let pago of pagosRegistrados(); let i = index" 
               class="pago-item bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-3">
                <div [class]="getPagoBadgeClass(pago.metodo)" 
                     class="px-3 py-1 rounded-full text-sm font-medium">
                  {{ pago.metodo }}
                </div>
                <div class="text-lg font-bold text-green-600">
                  {{ pago.monto | number:'1.2-2' }}
                </div>
              </div>
              <div class="text-sm text-gray-500 text-right">
                {{ formatearFecha(pago.fecha) }}
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
              <div *ngIf="pago.autorizacion">
                <span class="font-medium">Autorización:</span> {{ pago.autorizacion }}
              </div>
              <div *ngIf="pago.nota">
                <span class="font-medium">Nota:</span> {{ pago.nota }}
              </div>
            </div>
          </div>
        </div>

        <!-- Botón para agregar más pagos -->
        <div *ngIf="pagosRegistrados().length > 0" class="mt-6 text-center">
          <button mat-flat-button 
                  color="primary"
                  (click)="registrarPagoAdelanto()"
                  class="save-button">
            <mat-icon>add_circle</mat-icon>
            Agregar Otro Pago
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

        <!-- Botones de Acción -->
        <mat-card class="form-card">
          <mat-card-content>
            <div class="flex gap-4">
              <button mat-flat-button 
                      color="primary" 
                      (click)="guardarBorrador()" 
                      [disabled]="!pacienteId()"
                      class="save-button flex-1 py-3">
                <mat-icon>save</mat-icon>
                Guardar Visita
              </button>              
              <button mat-flat-button 
                      color="accent" 
                      [disabled]="!historiaId()"
                      (click)="registrarPagoAdelanto()"                       
                      class="payment-button flex-1 py-3">
                <mat-icon>payments</mat-icon>
                Registrar pago / adelanto
              </button>
            </div>
            
            <!-- Estado del formulario (opcional, para debug) -->
            <div class="mt-4 p-3 bg-gray-50 rounded-lg" *ngIf="true"> 
            <h4 class="font-medium text-sm text-gray-700 mb-2">Estado del formulario:</h4>
            <div class="text-xs text-gray-600 space-y-1">
              <div>Paciente: {{ pacienteId() ? 'Seleccionado' : 'No seleccionado' }}</div>
              <div>Agudeza Visual: {{ (avSinOD || avSinOI || avConOD || avConOI) ? 'Capturada' : 'No capturada' }}</div>
              <div>RX: {{ filasRx.length > 0 ? 'Configurada' : 'No configurada' }}</div>
              <div>Materiales: {{ materialesSel().length }} seleccionados</div>
              <div>Armazones: {{ armazonesSel.length }} seleccionados</div>
              <div>Lentes Contacto: {{ lentesContactoSel.length }} seleccionados</div>
              <!-- Agregar esta línea -->
              <div>Pagos: {{ pagosRegistrados().length }} registrados ({{ totalPagado | number:'1.2-2' }})</div>
            </div>
          </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Col 3: Últimas visitas -->
    <div class="space-y-8" *ngIf="pacienteId()">
      <mat-card class="form-card">
        <mat-card-header class="border-b border-gray-100 pb-4">
          <mat-card-title class="flex items-center gap-2 text-lg font-semibold">
            <mat-icon class="text-primary">history</mat-icon>
            Historial del Paciente
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <app-ultimas-visitas [pacienteId]="pacienteId()"></app-ultimas-visitas>            
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>